<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Beach Volley Scheduler</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
        header { background: #ff9800; color: white; padding: 10px; text-align: center; }
        .container { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .day { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        button { background: #ff9800; color: white; border: none; padding: 5px; margin: 2px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #e68a00; }
        input[type="text"], input[type="tel"] { width: 90%; margin: 3px 0; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .guest-names { margin-top: 5px; text-align: left; font-size: 0.9em; }
        .guest-names input { width: 100%; margin-bottom: 3px; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px;
            border-radius: 4px;
            z-index: 1000;
            display: none;
        }
        .participant-list { margin-top: 10px; text-align: left; font-size: 0.9em; }
    </style>
</head>
<body>
<header>
    <h1>Beach Volley Scheduler</h1>
</header>
<div id="login" style="padding:20px; display:none;">
    <h3>Inserisci i tuoi dati</h3>
    <input type="text" id="name" placeholder="Nome" required><br><br>
    <input type="tel" id="phone" placeholder="Telefono" required><br><br>
    <button onclick="saveUser()">Salva</button>
</div>
<div id="main" style="display:none;">
    <div style="padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
        <h3>Calendario prossime 2 settimane</h3>
        <button onclick="refreshData()">Aggiorna</button>
    </div>
    <div class="container" id="eventsGrid"></div>
</div>
<div id="toast" class="toast"></div>

<div id="loading-indicator" style="display:none; text-align:center; padding:20px;">
    Caricamento dati...
</div>

<script>
    // Configurazione GitHub
    const GITHUB_USERNAME = "masca87";
    const REPO_NAME = "beachvolley";

    // ****** ATTENZIONE: TOKEN GITHUB ESPOSTO NEL CODICE CLIENT-SIDE ******
    // Questo rende il token visibile a chiunque ispezioni la pagina.
    // Usalo solo per test o per scopi non critici con un token temporaneo e revocabile.
    // Revoca questo token immediatamente dopo l'uso o quando non è più necessario.
    const GITHUB_TOKEN = "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"; // Il tuo token fornito

    // Variabili globali
    let user = JSON.parse(localStorage.getItem('user'));
    let events = [];

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function saveUser() {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();

        if (!name || !phone) {
            showToast('Inserisci nome e telefono');
            return;
        }

        if (!/^[0-9+ ]+$/.test(phone)) {
            showToast('Numero di telefono non valido. Usa solo numeri, + e spazi.');
            return;
        }

        user = { name, phone };
        localStorage.setItem('user', JSON.stringify(user));
        showMain();
        showToast('Dati salvati con successo');
    }

    function showMain() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        loadEvents();
    }

    function refreshData() {
        loadEvents();
        showToast('Dati aggiornati');
    }

    if (user) {
        showMain();
    } else {
        document.getElementById('login').style.display = 'block';
    }

    async function loadEvents() {
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';

        try {
            const today = new Date();
            today.setHours(0,0,0,0);

            // Per la lettura, useremo l'API dei contenuti di GitHub per ottenere il SHA
            // e anche per caricare il contenuto.
            const response = await fetch(
                `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/events.json`,
                {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`, // Usiamo il token anche per leggere
                        'Accept': 'application/vnd.github.v3.raw' // Chiediamo il contenuto raw direttamente
                    }
                }
            );

            if (!response.ok) {
                if (response.status === 404) {
                    console.warn("File events.json non trovato, creando un array vuoto.");
                    events = []; // Inizializza con un array vuoto se il file non esiste
                } else {
                    const errorData = await response.json();
                    throw new Error(`Errore HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
            } else {
                // Se la risposta è OK, tenta di parsare il JSON
                let remoteEvents = await response.json();
                events = remoteEvents.filter(e => new Date(e.date) >= today);
            }

            // Assicurati di avere 14 giorni di copertura
            for (let i = 0; i < 14; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                const dayStr = day.toISOString().split('T')[0];

                if (!events.some(e => e.date.startsWith(dayStr))) {
                    events.push({
                        id: Date.now() + i,
                        date: day.toISOString(),
                        place: '',
                        participants: []
                    });
                }
            }

            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            renderGrid(events);

        } catch (error) {
            console.error("Errore nel caricamento degli eventi:", error);
            events = JSON.parse(localStorage.getItem('events')) || [];
            renderGrid(events);
            showToast(`Connessione fallita: ${error.message || 'Controlla il token GitHub e la connessione.'}`);
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // Funzione di salvataggio modificata per usare il PAT direttamente per la scrittura
    async function saveEvents() {
        showToast('Salvataggio dati su GitHub...');
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.textContent = "Salvataggio in corso...";
        loadingIndicator.style.display = 'block';

        try {
            // STEP 1: Ottieni l'SHA corrente del file events.json
            const getResponse = await fetch(
                `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/events.json`,
                {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );

            if (!getResponse.ok) {
                 // Se il file non esiste (404), procediamo senza SHA (creeremo il file)
                if (getResponse.status === 404) {
                    console.log("File events.json non trovato, verrà creato.");
                    // Non settiamo sha, la richiesta PUT lo creerà.
                } else {
                    const errorData = await getResponse.json();
                    throw new Error(`Errore GET SHA: ${getResponse.status} - ${errorData.message || getResponse.statusText}`);
                }
            }

            let sha = null;
            if (getResponse.ok) { // Se la richiesta GET è andata a buon fine, estrai l'SHA
                const fileData = await getResponse.json();
                sha = fileData.sha;
            }

            // STEP 2: Aggiorna (o crea) il file con il nuovo contenuto
            const updateResponse = await fetch(
                `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/events.json`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Aggiornamento eventi beach volley dalla webapp', // Messaggio di commit
                        content: btoa(JSON.stringify(events)), // Dati degli eventi codificati in base64
                        sha: sha // L'SHA è richiesto per gli aggiornamenti, non per la creazione
                    })
                }
            );

            if (!updateResponse.ok) {
                const errorData = await updateResponse.json();
                throw new Error(`Salvataggio fallito: ${updateResponse.status} - ${errorData.message || updateResponse.statusText}`);
            }

            localStorage.setItem('events', JSON.stringify(events)); // Salva anche localmente per consistenza
            showToast('Dati salvati con successo su GitHub!');
            return true;

        } catch (error) {
            console.error("Errore nel salvataggio degli eventi:", error);
            showToast(`Salvataggio fallito su GitHub: ${error.message}.`);
            return false;
        } finally {
            loadingIndicator.style.display = 'none';
            loadingIndicator.textContent = "Caricamento dati...";
        }
    }

    function renderGrid(events) {
        const grid = document.getElementById('eventsGrid');
        grid.innerHTML = '';

        const dateFormatter = new Intl.DateTimeFormat('it-IT', {
            weekday: 'short',
            day: 'numeric',
            month: 'numeric'
        });

        for (const event of events) {
            const day = new Date(event.date);
            const total = event.participants.reduce((acc, p) => acc + 1 + (p.guests ? p.guests.length : 0), 0);
            const div = document.createElement('div');
            div.className = 'day';

            const existingParticipant = event.participants.find(p => p.phone === user?.phone);
            let guestInputsHtml = '';

            if (existingParticipant?.guests?.length > 0) {
                for(let i = 0; i < existingParticipant.guests.length; i++) {
                    const guestName = existingParticipant.guests[i] || '';
                    guestInputsHtml += `
                        <input type="text"
                               placeholder="Nome +${i+1}"
                               value="${escapeHtml(guestName)}"
                               onchange="updateGuestName(${event.id}, '${escapeHtml(user.phone)}', ${i}, this.value)" />
                    `;
                }
            }

            div.innerHTML = `
                <strong>${dateFormatter.format(day)}</strong><br>
                <input type="text"
                       placeholder="Luogo"
                       value="${escapeHtml(event.place || '')}"
                       onchange="updatePlace(${event.id}, this.value)"><br>
                <p>Iscritti: ${total}</p>
                <button onclick="toggleParticipation(${event.id})">
                    ${existingParticipant ? 'Rimuovi' : 'Partecipo'}
                </button>
                <button onclick="addGuests(${event.id}, 1)" ${!existingParticipant ? 'disabled' : ''}>
                    +1
                </button>
                <button onclick="addGuests(${event.id}, 2)" ${!existingParticipant ? 'disabled' : ''}>
                    +2
                </button>
                <div class="guest-names">${guestInputsHtml}</div>
                <div class="participant-list">
                    ${event.participants.length > 0 ?
                        event.participants.map(p =>
                            `${escapeHtml(p.name)}${p.guests?.length > 0 ? ` (+${p.guests.length})` : ''}`
                        ).join('<br>') :
                        'Nessun partecipante'}
                </div>
            `;
            grid.appendChild(div);
        }
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    async function updatePlace(id, value) {
        const event = events.find(e => e.id === id);
        if (event) {
            event.place = value;
            const success = await saveEvents();
            if (success) showToast('Luogo aggiornato su GitHub');
        }
    }

    async function toggleParticipation(id) {
        const event = events.find(e => e.id === id);
        if (!event || !user) return;

        const existingIndex = event.participants.findIndex(p => p.phone === user.phone);

        if (existingIndex >= 0) {
            if (!confirm('Sei sicuro di voler rimuovere la tua partecipazione?')) {
                return;
            }
            event.participants.splice(existingIndex, 1);
            const success = await saveEvents();
            if (success) {
                showToast('Partecipazione rimossa da GitHub');
                // Ricarica la griglia per aggiornare i pulsanti e la lista
                loadEvents();
            }
        } else {
            event.participants.push({
                name: user.name,
                phone: user.phone,
                guests: []
            });
            const success = await saveEvents();
            if (success) {
                showToast('Partecipazione registrata su GitHub');
                // Ricarica la griglia per aggiornare i pulsanti e la lista
                loadEvents();
            }
        }
    }

    async function addGuests(id, count) {
        const event = events.find(e => e.id === id);
        if (!event || !user) return;

        const participant = event.participants.find(p => p.phone === user.phone);
        if (!participant) {
            showToast('Devi prima partecipare per aggiungere amici');
            return;
        }

        participant.guests = participant.guests || [];

        if (participant.guests.length === count) {
            showToast(`Hai già ${count} ospiti registrati.`);
            return;
        }

        if (participant.guests.length > count) {
            participant.guests.length = count;
        } else {
            while (participant.guests.length < count) {
                participant.guests.push('');
            }
        }

        const success = await saveEvents();
        if (success) {
            showToast(`Aggiornati a ${count} ospiti su GitHub`);
            loadEvents(); // Ricarica per aggiornare l'interfaccia con i nuovi input
        }
    }

    async function updateGuestName(eventId, phone, guestIndex, name) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;

        const participant = event.participants.find(p => p.phone === phone);
        if (!participant || !participant.guests) return;

        participant.guests[guestIndex] = name.trim();
        await saveEvents(); // Questo salverà su GitHub.
    }

    // Polling per aggiornamenti automatici (ogni 30 secondi)
    // Questo caricherà i dati da GitHub, inclusi i cambiamenti fatti da altri.
    setInterval(refreshData, 30000);
</script>
</body>
</html>
